<!DOCTYPE html>
<html>

<head>
    <title>A Study on Street View Images</title>
    <meta charset="UTF-8">

    <!--Javascript Files-->
    <script src="lib/vendors/jspsych-7.1.2/jspsych.js"></script>
    <script src="lib/jspsych-7-pavlovia-2022.1.1.js"></script>
    <script src="assets/scripts/groups.js"></script>

    <!--jsPsych Plugins-->
    <script src="lib/vendors/jspsych-7.1.2/plugin-browser-check.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-preload.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-html-button-response.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-html-form.js"></script>
    <script src="lib/vendors/jspsych-7.1.2/plugin-survey-text.js"></script>

    <!--CSS Files-->
    <link rel="stylesheet" href="lib/vendors/jspsych-7.1.2/jspsych.css">
    <link rel="stylesheet" href="https://unpkg.com/@jspsych/plugin-survey@0.1.1/css/survey.css">
    <link rel="stylesheet" href="assets/css/jsPsych-padding.css">
    <link rel="stylesheet" href="assets/css/jsPsych-text-edits.css">
</head>

<body></body>

<script>
    ////////* STUDY SETUP */////////
    /* VARIABLES */

    // Google API
    // const API_KEY = "AIzaSyCktc4Ble5kxzMmWAG7Nar5yBCOD2NjkSw";
    const API_KEY = 'AIzaSyC2OxRDg6qlzZDj7j0UAD2XyE0qWokLvvs';

    // jsPsych
    var jsPsych = initJsPsych({
        use_webaudio: false,
        on_finish: function () {
            window.open("https://sites.lsa.umich.edu/misl/", "_blank");
        }
    });

    // timeline 
    var timeline = [];

    // capture url params
    // var urlvar = JSON.stringify(jsPsych.data.urlVariables());

    // group assignment
    var group = jsPsych.randomization.randomInt(1, 14);
    var svList = groups[group - 1];

    // add global data variables
    // jsPsych.data.addProperties(Object.assign({}, urlVar, { group: group }));
    jsPsych.data.addProperties({ group: group });

    /* init connection with pavlovia.org */
    var pavlovia_init = {
        type: jsPsychPavlovia,
        data: {
            task: 'pavlovia-init'
        },
        command: "init"
    };

    // browser check
    var browserCheck = {
        type: jsPsychBrowserCheck,
        data: {
            task: 'browser-check'
        },
        minimum_width: 700
    };

    // preload
    var preload = {
        type: jsPsychPreload,
        images: [
            'assets/img/ambiguous-low.png',
            'assets/img/ambiguous-high.png',
            'assets/img/invisible-low.png',
            'assets/img/invisible-high.png',
            'assets/img/attention-check.png',
            'assets/img/countdown-15.gif'
        ],
        message: `Please wait while the experiment loads. This should not take longer than a minute.`
    }

    // street view image size parameters
    const svWidth = 640;
    const svHeight = 320;

    /* HELPER FUNCTIONS */
    /**
     * A function to get street view image using coordinates.
     * See https://developers.google.com/maps/documentation/streetview/overview#url-parameters
     * for detailed descriptions of these parameters
     * @param {Number} lat      latitude of location
     * @param {Number} lng      longitude of location
     * @param {Number} heading  heading of the camera (angle), between 0 and 360
     * @param {Number} pitch    tilt angle of the camera
     * @param {Number} fov      field of view of the image (zoom in or out), 
     *                          Google default is 90.
     * @param {Number} width    width of the returning image
     * @param {Number} height   height of the returning image
     * @return an html string of an `img` tag with all above parameters
     */
    function getSVCoord(lat, lng, heading, pitch, fov, width = svWidth, height = svHeight) {
        var imgTag = `
            <img src='
            https://maps.googleapis.com/maps/api/streetview?size=${width}x${height}
            &location=${lat},${lng}
            &heading=${heading}
            &pitch=${pitch}
            &fov=${fov}
            &radius=150
            &key=${API_KEY}
            &source=outdoor'>
        `
        return imgTag
    };

    /**
     * A function to get street view image using address or location name.
     * See https://developers.google.com/maps/documentation/streetview/overview#url-parameters
     * for detailed descriptions of these parameters
     * @param {String} location location name or street address     
     * @param {Number} heading  heading of the camera (angle), between 0 and 360
     * @param {Number} pitch    tilt angle of the camera
     * @param {Number} fov      field of view of the image (zoom in or out), 
     *                          Google default is 90.
     * @param {Number} width    width of the returning image
     * @param {Number} height   height of the returning image
     * @return an html string of an `img` tag with all above parameters
     */
    function getSVLoc(location, heading, pitch, fov, width = svWidth, height = svHeight) {
        var imgTag = `
            <img src='
            https://maps.googleapis.com/maps/api/streetview?size=${width}x${height}
            &location=${location}
            &heading=${heading}
            &pitch=${pitch}
            &fov=${fov}
            &radius=150
            &key=${API_KEY}
            &source=outdoor'>
        `
        return imgTag
    };


    ////////* EXPERIMENT */////////
    /* WELCOME MESSAGE */
    const html_intro1 = `
        <div class="text-container">
            <h1>Welcome to the study!</h1>
            
            <div class="text-left">
                <p>
                    In this study, we are interested in how people think about different Google Street View images. Google Street View takes pictures of streets used for Google Earth and Google Maps. You’ll see Google Street View images of different places and answer some questions about each one.
                </p>
            </div>
            ${getSVCoord(37.783631, -122.432766, 80, 2, 100)}
            <br>
        <br>
    `;

    var intro1 = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'instructions',
        },
        post_trial_gap: 300,
        choices: ['Next'],
        stimulus: html_intro1
    };

    const html_intro2 = `
        <style>
            img.small {
            max-width: 100px;
            }
            li {
            text-indent: 40px;
            }
        </style>

        <div class="text-container text-left">
            <p>For each picture, we’d like your impressions of the scene:</p>
            
            <hr>
                Are there <b>clear, distinct boundaries</b> between objects in the scene, or are the <b>boundaries ambiguous or unclear</b>?
                
                <li>clear, distinct boundaries: <img class="small" src="assets/img/ambiguous-low.png"></li>
                <li>ambiguous or unclear boundaries: <img class="small" src="assets/img/ambiguous-high.png"></li>
            <hr>
            <br>
                Are there <b>only a few different objects</b> in the scene, or is there <b>a large number</b>?
            <br><br>
            <hr>
                Are only <b>a few parts</b> of the scene <b>invisible or obscured</b>, or are <b>many parts invisible or obscured</b>?
                
                <li>a few parts invisible or obscured: <img class="small" src="assets/img/invisible-low.png"></li>
                <li>many parts invisible or obscured: <img class="small" src="assets/img/invisible-high.png"></li>
            <hr>
            <br>
                Does the scene look <b>organized</b> or <b>chaotic</b> to you?
            <br><br>
            <hr>
            
            <p>
                There are no right or wrong answers: we are interested in <b>your</b> impression. Note that some images might have individual buildings or faces blurred for privacy. Please ignore these when making your judgments.
            </p>
        </div>
        <br>
    `;

    var intro2 = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'instructions',
        },
        choices: ['Next'],
        stimulus: html_intro2
    };

    const html_intro3 = `
        <div class="text-container text-left">
            <p>Please make sure you are doing this study in an area where you can focus and complete the survey in one sitting.</p>

            <p>Don’t spend too much time on any one picture, and, again go with your gut impression!</p>
            
            <p>The study should take about 30 minutes. We’ll let you know when you’re halfway through.</p>
        </div>
            
        <h3>Ready? Click next to get started!</h3>
        <br>
    `;

    var intro3 = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'instructions',
        },
        choices: ['Next'],
        stimulus: html_intro3
    };

    // function to generate new trial with location info
    function newTrial(loc) {
        var locData = svList[loc];
        var locLat = locData['lat'];
        var locLng = locData['lng'];
        var locHeading = locData['angle']
        locData['loc_id'] = loc;
        delete locData['exclude'];

        var trialNew = {
            type: jsPsychSurvey,
            data: Object.assign({}, locData, { 'task': 'trial' }),
            pages: [[
                {
                    type: 'html',
                    prompt: `
                        <style>
                            .sv_q.sv_qstn {
                            align-items: center;
                            justify-content: center;
                            text-align: center;
                            }
                            .sv_body {
                            color: #000000;
                            font-size: 95%;
                            }
                            .sv_main .sv_container .sv_body .sv_p_root .sv_q_title {
                            font-weight: bold;
                            }
                            .sv_q_rating_min_text {
                            min-width: 150px;
                            }
                        </style>

                        <p>Take a look at the following landscape from Google Street View</p>
                        ${getSVCoord(locLat, locLng, locHeading)}
                        <h3>In this image, ...</h3>
                    `,
                }, {
                    type: 'likert',
                    prompt: "how ambiguous is the boundary of each object?",
                    name: 'ambiguous',
                    likert_scale_min_label: 'Distinct, Clear',
                    likert_scale_max_label: 'Ambiguous, Unclear',
                    likert_scale_values: [
                        { value: 1 },
                        { value: 2 },
                        { value: 3 },
                        { value: 4 },
                        { value: 5 }
                    ]
                }, {
                    type: 'likert',
                    prompt: "how many different objects do there seem to be?",
                    name: 'objects',
                    likert_scale_min_label: 'Relatively few',
                    likert_scale_max_label: 'Enormous number',
                    likert_scale_values: [
                        { value: 1 },
                        { value: 2 },
                        { value: 3 },
                        { value: 4 },
                        { value: 5 }
                    ]
                }, {
                    type: 'likert',
                    prompt: "to what degree do there seem to be parts of the scene that are invisible?",
                    name: 'invisible',
                    likert_scale_min_label: 'Few invisible parts',
                    likert_scale_max_label: 'Many invisible parts',
                    likert_scale_values: [
                        { value: 1 },
                        { value: 2 },
                        { value: 3 },
                        { value: 4 },
                        { value: 5 }
                    ]
                }, {
                    type: 'likert',
                    prompt: "to what degree is the scene either organized or chaotic?",
                    name: 'chaos',
                    likert_scale_min_label: 'Organized',
                    likert_scale_max_label: 'Chaotic',
                    likert_scale_values: [
                        { value: 1 },
                        { value: 2 },
                        { value: 3 },
                        { value: 4 },
                        { value: 5 }
                    ]
                }
            ]],
            button_label_finish: 'Continue'
        };

        return (trialNew);
    };

    var half_way = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'half-way'
        },
        stimulus: `
            <h3>You are now half way through the study.</h3>
            <p>Please take a quick, 15-second break before you continue.</p>
            <img src='assets/img/countdown-15.gif'>
            <p>The study will automatically advance forward after the countdown is complete. However, you may click "Next" to advance forward now if you wish.</p>
        `,
        choices: ['Next'],
        trial_duration: 15750
    };

    var attention_check = {
        type: jsPsychSurvey,
        data: {
            task: 'attention-check'
        },
        pages: [[
            {
                type: 'html',
                prompt: `
                    <style>
                    .sv_q.sv_qstn {
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                    }
                    .sv_body {
                        color: #000000;
                        font-size: 95%;
                    }
                    .sv_main .sv_container .sv_body .sv_p_root .sv_q_title {
                        font-weight: bold;
                    }
                    .sv_q_rating_min_text {
                        min-width: 150px;
                    }
                    </style>
                    <p>Take a look at the following landscape from Google Street View</p>
                    <img src='assets/img/attention-check.png'>
                    <h3>In this image, ...</h3>
                `,
            }, {
                type: 'likert',
                prompt: "how ambiguous is the boundary of each object?",
                name: 'ambiguous',
                likert_scale_min_label: 'Distinct, Clear',
                likert_scale_max_label: 'Ambiguous, Unclear',
                likert_scale_values: [
                    { value: 1 },
                    { value: 2 },
                    { value: 3 },
                    { value: 4 },
                    { value: 5 }
                ]
            }, {
                type: 'likert',
                prompt: "how many different objects do there seem to be?",
                name: 'objects',
                likert_scale_min_label: 'Relatively few',
                likert_scale_max_label: 'Enormous number',
                likert_scale_values: [
                    { value: 1 },
                    { value: 2 },
                    { value: 3 },
                    { value: 4 },
                    { value: 5 }
                ]
            }, {
                type: 'likert',
                prompt: "to what degree do there seem to be parts of the scene that are invisible?",
                name: 'invisible',
                likert_scale_min_label: 'Few invisible parts',
                likert_scale_max_label: 'Many invisible parts',
                likert_scale_values: [
                    { value: 1 },
                    { value: 2 },
                    { value: 3 },
                    { value: 4 },
                    { value: 5 }
                ]
            }, {
                type: 'likert',
                prompt: "to what degree is the scene either organized or chaotic?",
                name: 'chaos',
                likert_scale_min_label: 'Organized',
                likert_scale_max_label: 'Chaotic',
                likert_scale_values: [
                    { value: 1 },
                    { value: 2 },
                    { value: 3 },
                    { value: 4 },
                    { value: 5 }
                ]
            }
        ]],
        button_label_finish: 'Continue'
    };

    /* DEMOGRAPHICS */
    const preambleDemog = `
        <br>
        <p>Thank you for your responses. Finally, we’d like to ask you a few questions about yourself.</p>
        <hr>
        <br>
    `;

    function selfDescribe() {
        a = document.getElementById('self-describe');
        a.checked = true;
    };

    const htmlDemogForm1 = `
        <label for="age">What is your age in years?<br>
            <input type="number" id="age" name="age" min=18><br><br>
        </label>
        
        <label for="gender">How do you currently describe your gender identity?<br>
            <div class="text-left" style="max-width:200px; margin:auto;">
            <label for="female" style="font-size:85%">
                <input type="radio" id="female" name="gender" value="female">
                Female
            </label><br>
            
            <label for="male" style="font-size:85%">
                <input type="radio" id="male" name="gender" value="male">
                Male
            </label><br>
            
            <label for="nonbinary" style="font-size:85%">
                <input type="radio" id="nonbinary" name="gender" value="nonbinary">
                Nonbinary
            </label><br>
            
            <label for="self-describe" onClick=selfDescribe() style="font-size:85%">
                <input type="radio" id="self-describe" name="gender" value="self-describe">
                Prefer to self-describe:<br> &nbsp;&nbsp;&nbsp;   
                <input type="text" id="self-describe" name="gender-self-describe">
            </label>
            </div>
        </label><br><br>
        
        <label for="zipcode">What's the zipcode of your current residence?<br>
            <input type="number" id="zipcode" name="zipcode">
        </label><br><br>
    `;

    var demogForm = {
        type: jsPsychSurveyHtmlForm,
        data: {
            task: 'demographics'
        },
        preamble: preambleDemog,
        html: htmlDemogForm1,
        choices: ['Next'],
    };

    /* END OF STUDY */
    var endSurveyDebrief = {
        type: jsPsychSurveyText,
        data: {
            task: 'end-survey'
        },
        questions: [
            {
                prompt: 'Do you have any comments on the study you’d like to share?',
                rows: 8,
                columns: 80
            }
        ]
    };

    var endStudy = {
        type: jsPsychHtmlButtonResponse,
        data: {
            task: 'end-survey'
        },
        stimulus: `<p>Thanks for participating! Please do not close this browser tab until you are redirected.</p>`,
        choices: [],
        trial_duration: 3500
    }

    /* finish connection with pavlovia.org */
    var pavlovia_finish = {
        type: jsPsychPavlovia,
        data: {
            task: 'pavlovia-finish'
        },
        command: "finish",
        // participantId: "JSPSYCH-DEMO"
    };

    /* timeline */
    timeline.push(pavlovia_init);
    timeline.push(browserCheck);
    timeline.push(preload);
    timeline.push(intro1);
    timeline.push(intro2);
    timeline.push(intro3);

    // Push trials
    var shuffledList = jsPsych.randomization.shuffle(Object.keys(svList)).slice(0, 4);
    shuffledList.splice(shuffledList.length / 2, 0, "half-way");
    shuffledList.splice(shuffledList.length / 2, 0, "attention-check");

    for (loc of shuffledList) {
        if (loc == 'half-way') {
            timeline.push(half_way);
        } else if (loc == 'attention-check') {
            timeline.push(attention_check);
        } else {
            timeline.push(newTrial(loc));
        }
    };

    timeline.push(demogForm);
    timeline.push(endSurveyDebrief);
    timeline.push(endStudy);
    timeline.push(pavlovia_finish);

    /* start the experiment */
    jsPsych.run(timeline);

</script>

</html>